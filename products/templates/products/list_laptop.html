{% load static %}

<link rel="stylesheet" href="{% static 'css/products/list_laptop.css' %}">

<div id="products-container">
    <!-- Products will be dynamically added here -->
</div>
<script src="{% static 'js/price/formatPrice.js' %}"></script>

<script>
    async function fetchData() {
        try {
            let brandsResponse = await fetch('/api/brands/');
            let laptopSpecsResponse = await fetch('/api/laptop-specs/');
            let brands = await brandsResponse.json();
            let laptopSpecs = await laptopSpecsResponse.json();

            let container = document.getElementById('products-container');
            container.innerHTML = '';

            brands.forEach(brand => {
                let brandSection = document.createElement('div');
                brandSection.id = brand.slug;
                brandSection.innerHTML = `
                    <div class="text-center mt-5 mb-3 bg-light p-3 border rounded">
                        <img src="${brand.logo}" width="120" class="img-fluid" />
                    </div>
                    <div class="row" id="${brand.slug}-products">
                    </div>
                `;
                container.appendChild(brandSection);

                let brandProducts = laptopSpecs.filter(spec => spec.product.brand.id === brand.id);

                let productsContainer = document.getElementById(`${brand.slug}-products`);
                if (brandProducts.length === 0) {
                    console.warn(`No products found for brand ${brand.name}`);
                }

                brandProducts.forEach(spec => {
                    let productImage = spec.product.images.length > 0 ? spec.product.images[0].image : '/static/placeholder_image.jpg';
                    let gpuDetails = spec.gpu.map(gpu => `${gpu.gpu_brand.name} ${gpu.model}`).join(', ');
                    let productCard = document.createElement('div');
                    productCard.className = 'col-6 col-md-4 col-lg-3 mb-4';
                    productCard.innerHTML = `
                        <div class="product-card">
                            <div class="warranty-badge">
                                ${spec.product.warranty_years > 0
                                    ? `${spec.product.warranty_years} ${spec.product.warranty_years === 1 ? 'year' : 'years'} warranty`
                                    : spec.product.warranty_months > 0
                                        ? `${spec.product.warranty_months} ${spec.product.warranty_months === 1 ? 'month' : 'months'} warranty`
                                        : 'No warranty'
                                }
                            </div>
                            <div class="product-image-container">
                                <img class="product-image" src="${productImage}" alt="${spec.product.name}">
                            </div>
                            <div class="product-info">
                                <h4 class="product-title">${spec.product.name} ${spec.product.model} ${spec.product.year}</h4>
                                <p class="product-specs">${spec.cpu.cpu_brand.name} ${spec.cpu.model} | ${gpuDetails} | ${spec.storage.capacity}${spec.storage.capacity_type} ${spec.memory.capacity}GB | ${spec.product.color.name}</p>
                                <div class="product-footer">
                                    <h3 class="product-price">$${formatPrice(spec.product.price)}</h3>
                                    <a href="/products/${spec.slug}/" class="btn btn-primary see-more-btn"><i class="fa-solid fa-eye"></i></a>
                                </div>
                            </div>
                        </div>
                    `;
                    productsContainer.appendChild(productCard);
                });
            });
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', fetchData);
</script>